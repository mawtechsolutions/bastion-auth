# ============================================
# AlertManager Configuration for BastionAuth
# ============================================

global:
  # SMTP configuration for email alerts
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@bastionauth.dev'
  smtp_auth_username: ''
  smtp_auth_password: ''
  
  # Slack webhook for notifications
  slack_api_url: ''

# Route configuration
route:
  # Default receiver
  receiver: 'default-receiver'
  
  # Group by alertname
  group_by: ['alertname', 'severity']
  
  # Wait before sending notification
  group_wait: 30s
  
  # Wait before sending new notification for same group
  group_interval: 5m
  
  # Wait before resending notification
  repeat_interval: 4h

  # Child routes
  routes:
    # Critical alerts go to PagerDuty/immediate
    - match:
        severity: critical
      receiver: 'critical-receiver'
      group_wait: 10s
      repeat_interval: 1h

    # Warning alerts go to Slack
    - match:
        severity: warning
      receiver: 'warning-receiver'
      group_wait: 1m
      repeat_interval: 4h

# Inhibition rules
inhibit_rules:
  # If service is down, don't alert for slow response
  - source_match:
      alertname: 'BastionAuthDown'
    target_match_re:
      alertname: 'BastionAuthSlow.*'
    equal: ['instance']

  # If database is down, don't alert for service issues
  - source_match:
      alertname: 'BastionAuthDatabaseDown'
    target_match:
      alertname: 'BastionAuthDown'
    equal: []

# Receivers
receivers:
  - name: 'default-receiver'
    # Email notifications
    email_configs:
      - to: 'alerts@bastionauth.dev'
        send_resolved: true

  - name: 'critical-receiver'
    # Slack for immediate visibility
    slack_configs:
      - channel: '#bastionauth-alerts'
        send_resolved: true
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
    
    # Email as backup
    email_configs:
      - to: 'oncall@bastionauth.dev'
        send_resolved: true

    # PagerDuty for critical issues (configure service key)
    # pagerduty_configs:
    #   - service_key: '<your-pagerduty-key>'
    #     send_resolved: true

  - name: 'warning-receiver'
    slack_configs:
      - channel: '#bastionauth-monitoring'
        send_resolved: true

# Templates
templates:
  - '/etc/alertmanager/templates/*.tmpl'

